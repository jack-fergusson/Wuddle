<%- include('header.ejs') %>
    <div class="container all-boards-container">
        <div class="roomName-container">
            <div class="spacer"></div>
            <h2><%= room.Name %></h2>
            <div class="spacer"></div>
        </div>
        <div class="container view-selector">
            <button class="unselected">
                <a href="/rooms/<%=roomID%>/<%=PlayerID%>">My Board</a>
            </button>
            <div class="spacer"></div>
            <button class="selected">
                <a href="/rooms/<%=roomID%>/<%=PlayerID%>/boards">All Boards</a>
            </button>
            <div class="spacer"></div>
            <button class="unselected">
                <a href="/rooms/<%=roomID%>/<%=PlayerID%>/chat">Chat</a>
            </button>
        </div>
        <div class="spacer"></div>
        <div class="container grid-container">
            <div class="boardGrid">
                <% for (let i = 0; i < room.Players.length; i++) { %>
                    <div class="container blank-board-container">
                        <div class="blank-board" id="<%= room.Players[i].ID %>">
                            <% for (let j = 0; j < 9; j++) { %>
                                <% if (room.Players[i].BoardState[j] == true ) { %>
                                    <div class="blank-square" id="<%= room.Players[i].ID %><%= j %>" style="background-color: #4daa57;">
                                        <div>
                                            <!-- Individual square of individiual player -->
                                        </div>
                                    </div>
                                <% } else { %>
                                    <div class="blank-square" id="<%= room.Players[i].ID %><%= j %>">
                                        <div>
                                            <!-- Individual square of individiual player -->
                                        </div>
                                    </div>
                                <% } %>
                            <% } %>
                        </div>
                        <div class="nametag" id="<%= room.Players[i].ID %>-nametag">
                            <h4 style="padding-top: 5px;"><%= room.Players[i].DisplayName %></h4>
                            <div class="container crowns-container">
                                <% if (room.Players[i].NumWins > 0 && room.Players[i].NumWins < 5) { %>
                                    <% for (let k = 0; k < room.Players[i].NumWins; k++) { %>
                                        <img src="/images/crown.svg" class="crown">
                                    <% } %>
                                    <div><h4 style="color: white; user-select: none;">`</h4></div>
                                <% } else if (room.Players[i].NumWins >= 5) { %>
                                    <img src="/images/crown.svg" class="crown"><h4>x <%= room.Players[i].NumWins %></h4>
                                <% } else { %>
                                    <div><h4 style="color: white; user-select: none;">`</h4></div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
        <div>
            <div class="spacer"></div>
        </div>
        <div class="container room-code-container">
            <h4>
                Room code:&nbsp;<span><%= room.ID %>&nbsp;</span>
                <button class="copy-button" id="opener" title="Copy Invitation" onclick="copyInvite()">
                    <img src="/images/copy.svg" class="copy">
                </button>
            </h4>
        </div>
        <div class="container copyText-container" id="copyText-container" style="display: none;">
            <textarea id="copyText" style="width: 100%; min-height: 50px;">Come play Wuddle! Follow this link to join the room '<%= room.Name %>' play-wuddle.com/rooms/<%= room.ID %> Please ensure you have cookies turned on!"</textarea>
            <button class="closeCopyText" onclick="closeCopyText()">X</button>
        </div>
        <div>
            <div class="spacer"></div>
            <div class="spacer"></div>
            <div class="spacer"></div>
        </div>

    <!-- <script src="http://<%= IP %>:3000/socket.io/socket.io.js"></script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        socket.emit('joinRoom', '<%=roomID%>');

        // Register hits from player pages and change color of given square
        socket.on('hit', (playerID, hitIndex, winCondition) => {
            document.getElementById(playerID + hitIndex).style.backgroundColor = "#4daa57";

            // if (winCondition) {
            //     document.getElementById("crown" + playerID).style.display = "block";
            // }
        });

        socket.on('newPlayer', (PlayerID, PlayerName) => {
            // TECHNICALLY works but I would like a more elegant solution at some point...
            // Some method of adding the new board to the list of boards and having it recognized
            location.reload();
        });

        socket.on('refresh', (Name, ID, NumWins) => {
            newNametag = `<h4 style="padding-top: 5px;">${Name}</h4>`;
            newNametag += `<div class="container crowns-container">`;

            if (NumWins > 0 && NumWins < 5) {
                for (let i = 0; i < NumWins; i++) {
                    newNametag += `<img src="/images/crown.svg" class="crown">`;
                }
                newNametag += `<div><h4 style="color: white; user-select: none;">,</h4></div>`;
            } else if (NumWins >= 5) {
                newNametag += `<img src="/images/crown.svg" class="crown"><h4>x ${NumWins}</h4>`;
            } else {
                newNametag += `<div><h4 style="color: white; user-select: none;">,</h4></div>`;
            }

            newNametag += `</div>`;

            document.getElementById(`${ID}-nametag`).innerHTML = newNametag;
        });

        socket.on('clear', (PlayerID) => {
            for (let i = 0; i < 9; i++) {
                document.getElementById(PlayerID + i.toString()).style.backgroundColor = "white";
            }

            // document.getElementById("crown" + PlayerID).style.display = "none";
        });

        function closeCopyText() {   
            document.getElementById("copyText-container").style = "display: none;";
        }

        function copyInvite() {
            navigator.permissions.query({ name: "clipboard-write" }).then((result) => {
                if (result.state === "granted" || result.state === "prompt") {
                    navigator.clipboard.writeText("Come play Wuddle!\nFollow this link to join the room '<%= room.Name %>' https://play-wuddle.com/rooms/<%= room.ID %>\nPlease ensure you have cookies turned on!");
                    alert("Invite copied to clipboard!");
                }
                else {
                    document.getElementById("copyText-container").style = "display: block; width: 40%";
                    document.getElementById("copyText").select();
                }
            });
        }

    </script>

<%- include('footer.ejs') %>